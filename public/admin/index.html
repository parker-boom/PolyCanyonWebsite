<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <div id="nc-root"></div>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    <script>
      CMS.registerPreviewStyle('preview.css');

      const StructurePreview = createClass({
        render: function () {
          const entry = this.props.entry;
          const structures = entry.getIn(['data', 'structures']) || [];

          return h(
            'div',
            { className: 'structures-preview' },
            structures.map((structure, index) => {
              const names = structure.get('names') || [];
              const otherNames = names.slice(1);
              const advisors = (structure.get('advisor_builders') || [])
                .filter((builder) =>
                  (builder.get('role') || []).includes('Advisor')
                )
                .map((advisor) => advisor.get('name'));
              const builders = (structure.get('advisor_builders') || []).map(
                (builder) => builder.get('name')
              );

              const renderField = (label, value, className = 'field') => {
                return h(
                  'div',
                  { className },
                  h('strong', {}, label),
                  h(
                    'span',
                    { className: value ? '' : 'not-provided' },
                    value || 'Not Provided'
                  )
                );
              };

              return h(
                'div',
                { key: index, className: 'structure-card' },
                // Title and Number
                h(
                  'h2',
                  {},
                  `${structure.getIn(['names', 0])} (${structure.get('number')})`
                ),

                // Other Names
                renderField(
                  'Other Names: ',
                  otherNames.length > 0 ? otherNames.join(', ') : null
                ),

                // Year
                renderField('Year: ', structure.get('year')),

                // Department
                renderField(
                  'Department: ',
                  structure.get('department').size > 0
                    ? structure.get('department').join(', ')
                    : null
                ),

                // Advisors
                renderField(
                  'Advisors: ',
                  advisors.length > 0 ? advisors.join(', ') : null
                ),

                // Builders
                renderField(
                  'Builders: ',
                  builders.length > 0 ? builders.join(', ') : null
                ),

                // Status
                renderField('Status: ', structure.get('status')),

                // Style
                renderField('Style: ', structure.get('style')),

                // Tags
                renderField(
                  'Tags: ',
                  structure.get('tags').size > 0
                    ? structure.get('tags').join(', ')
                    : null
                ),

                // Location
                renderField(
                  'Location: ',
                  structure.getIn(['location', 'latitude'])
                    ? `${structure.getIn(['location', 'latitude'])}, ${structure.getIn(['location', 'longitude'])}`
                    : null
                ),

                // Description
                renderField(
                  'Description: ',
                  structure.get('description'),
                  'field description'
                ),

                // Extended Description
                renderField(
                  'Extended Description: ',
                  structure.get('extended_description'),
                  'field description'
                ),

                // Images
                renderField(
                  'Images: ',
                  structure.get('images').size > 0
                    ? structure
                        .get('images')
                        .map((img) => img.get('type'))
                        .join(', ')
                    : null
                ),

                // Links
                renderField(
                  'Links: ',
                  structure.get('links').size > 0
                    ? structure
                        .get('links')
                        .map((link) => link.get('title'))
                        .join(', ')
                    : null
                )
              );
            })
          );
        },
      });

      CMS.registerPreviewTemplate('all_structures', StructurePreview);
      CMS.init();

      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', (user) => {
          if (!user) {
            window.netlifyIdentity.on('login', () => {
              document.location.href = '/admin/';
            });
          }
        });
      }
    </script>
  </body>
</html>
