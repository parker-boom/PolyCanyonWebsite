<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <div id="nc-root"></div>
    <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
    <script>
      CMS.registerPreviewStyle('preview.css');

      const StructurePreview = createClass({
        render: function () {
          const entry = this.props.entry;
          const structures = entry.getIn(['data', 'structures']) || [];

          return h(
            'div',
            { className: 'structures-preview' },
            structures.map((structure, index) => {
              const names = structure.get('names') || [];
              const otherNames = names.slice(1);
              const advisors = (structure.get('advisor_builders') || [])
                .filter((builder) =>
                  (builder.get('role') || []).includes('Advisor')
                )
                .map((advisor) => advisor.get('name'));
              const builders = (structure.get('advisor_builders') || []).map(
                (builder) => builder.get('name')
              );

              return h(
                'div',
                { key: index, className: 'structure-card' },
                // Title and Number
                h(
                  'h2',
                  {},
                  `${structure.getIn(['names', 0])} (${structure.get('number')})`
                ),

                // Other Names
                otherNames.length > 0 &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Other Names: '),
                    h('span', {}, otherNames.join(', '))
                  ),

                // Year
                h(
                  'div',
                  { className: 'field' },
                  h('strong', {}, 'Year: '),
                  h('span', {}, structure.get('year'))
                ),

                // Department
                structure.get('department').size > 0 &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Department: '),
                    h('span', {}, structure.get('department').join(', '))
                  ),

                // Advisors
                advisors.length > 0 &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Advisors: '),
                    h('span', {}, advisors.join(', '))
                  ),

                // Builders
                builders.length > 0 &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Builders: '),
                    h('span', {}, builders.join(', '))
                  ),

                // Status
                structure.get('status') &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Status: '),
                    h('span', {}, structure.get('status'))
                  ),

                // Style
                structure.get('style') &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Style: '),
                    h('span', {}, structure.get('style'))
                  ),

                // Tags
                structure.get('tags').size > 0 &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Tags: '),
                    h('span', {}, structure.get('tags').join(', '))
                  ),

                // Location
                structure.getIn(['location', 'latitude']) &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Location: '),
                    h(
                      'span',
                      {},
                      `${structure.getIn(['location', 'latitude'])}, ${structure.getIn(['location', 'longitude'])}`
                    )
                  ),

                // Description
                h(
                  'div',
                  { className: 'field description' },
                  h('strong', {}, 'Description: '),
                  h('p', {}, structure.get('description'))
                ),

                // Extended Description
                h(
                  'div',
                  { className: 'field description' },
                  h('strong', {}, 'Extended Description: '),
                  h('p', {}, structure.get('extended_description'))
                ),

                // Images
                structure.get('images').size > 0 &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Images: '),
                    h(
                      'span',
                      {},
                      structure
                        .get('images')
                        .map((img) => img.get('type'))
                        .join(', ')
                    )
                  ),

                // Links
                structure.get('links').size > 0 &&
                  h(
                    'div',
                    { className: 'field' },
                    h('strong', {}, 'Links: '),
                    h(
                      'span',
                      {},
                      structure
                        .get('links')
                        .map((link) => link.get('title'))
                        .join(', ')
                    )
                  )
              );
            })
          );
        },
      });

      CMS.registerPreviewTemplate('all_structures', StructurePreview);
      CMS.init();

      if (window.netlifyIdentity) {
        window.netlifyIdentity.on('init', (user) => {
          if (!user) {
            window.netlifyIdentity.on('login', () => {
              document.location.href = '/admin/';
            });
          }
        });
      }
    </script>
  </body>
</html>
